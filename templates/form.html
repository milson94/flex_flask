{% extends "base.html" %}

{% block head_extra_styles %}
{# No extra styles needed, using base styles #}
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-center text-sky-700 mb-8">Crie seu Currículo</h1> {# Updated Title #}
    <p class="text-center text-slate-500 text-sm mb-6">Preencha seus detalhes abaixo. Você pode adicionar múltiplas experiências e entradas de educação.</p>
    <form method="POST" action="{{ url_for('resume_form') }}" class="space-y-8">

        <!-- Personal Details Section -->
        <fieldset class="border border-slate-300 p-6 rounded-md">
            <legend class="text-xl font-semibold text-sky-600 px-2 mb-4">Detalhes Pessoais</legend>
            <div class="space-y-4">
                <div>
                    <label for="full_name" class="block text-sm font-medium text-slate-700 mb-1">Primeiro Nome:</label>
                    <input type="text" id="full_name" name="full_name" required value="{{ data.full_name | default('João', true) }}" class="form-input-base">
                </div>
                <div>
                    <label for="title_subtitle" class="block text-sm font-medium text-slate-700 mb-1">Cargo que está se candidatando:</label>
                    <input type="text" id="title_subtitle" name="title_subtitle" value="{{ data.title_subtitle | default('Desenvolvedor Web Sênior', true) }}" class="form-input-base">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-slate-700 mb-1">Email:</label>
                    <input type="email" id="email" name="email" required value="{{ data.email | default('joao.silva@email.com', true) }}" class="form-input-base">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-slate-700 mb-1">Telefone:</label>
                    <input type="tel" id="phone" name="phone" value="{{ data.phone | default('+351 912 345 678', true) }}" class="form-input-base">
                </div>
                <div>
                    <label for="linkedin" class="block text-sm font-medium text-slate-700 mb-1">LinkedIn/Portfólio:</label>
                    <input type="text" id="linkedin" name="linkedin" value="{{ data.linkedin | default('linkedin.com/in/joaosilvadev', true) }}" class="form-input-base">
                </div>
                <div>
                    <label for="location" class="block text-sm font-medium text-slate-700 mb-1">Local de Nascimento:</label>
                    <input type="text" id="location" name="location" value="{{ data.location | default('Porto, Portugal', true) }}" class="form-input-base">
                </div>
                <div>
                    <label for="nationality" class="block text-sm font-medium text-slate-700 mb-1">Nacionalidade:</label>
                    <select id="nationality" name="nationality" class="form-input-base">
                        <option value="Moçambicana" {% if data.nationality == 'Moçambicana' %}selected{% endif %}>Moçambicana</option>
                        <option value="Portuguesa" {% if data.nationality == 'Portuguesa' %}selected{% endif %}>Portuguesa</option>
                        <option value="Brasileira" {% if data.nationality == 'Brasileira' %}selected{% endif %}>Brasileira</option>
                        <option value="Angolana" {% if data.nationality == 'Angolana' %}selected{% endif %}>Angolana</option>
                        <option value="Americana" {% if data.nationality == 'Americana' %}selected{% endif %}>Americana</option>
                        <!-- Add more nationalities as needed -->
                    </select>
                </div>
                <div>
                    <label for="birth_date" class="block text-sm font-medium text-slate-700 mb-1">Data de Nascimento:</label>
                    <input type="date" id="birth_date" name="birth_date" value="{{ data.birth_date | default('1990-05-15', true) }}" class="form-input-base">
                </div>
                <div>
                    <label for="gender" class="block text-sm font-medium text-slate-700 mb-1">Gênero:</label>
                    <select id="gender" name="gender" class="form-input-base">
                        <option value="Masculino" {% if data.gender == 'Masculino' %}selected{% endif %}>Masculino</option>
                        <option value="Feminino" {% if data.gender == 'Feminino' %}selected{% endif %}>Feminino</option>
                        <option value="Outro" {% if data.gender == 'Outro' %}selected{% endif %}>Outro</option>
                        <option value="Prefiro não dizer" {% if data.gender == 'Prefiro não dizer' %}selected{% endif %}>Prefiro não dizer</option>
                    </select>
                </div>
                <div>
                    <label for="summary" class="block text-sm font-medium text-slate-700 mb-1">Resumo Profissional:</label>
                    <textarea id="summary" name="summary" rows="4" required class="form-textarea-base min-h-[80px]">{{ data.summary | default('Motivated Digital Marketing Manager with over 3 years of experience in driving user acquisition and growth through strategic paid campaigns.', true) }}</textarea>
                </div>
                <!-- NOTE: Profile Image upload is not implemented here, using default/sample -->
                <input type="hidden" name="profile_image_path" value="{{ data.profile_image_path | default('', true) }}">
                {% if data.profile_image_path %}
                 <p class="text-xs text-slate-500 mt-1">Current profile image path: {{ data.profile_image_path }} (Feature to upload not added yet).</p>
                {% endif %}
            </div>
        </fieldset>

        <!-- Key Achievements -->
        <fieldset class="border border-slate-300 p-6 rounded-md">
            <legend class="text-xl font-semibold text-sky-600 px-2 mb-4">Principais Conquistas (Opcional, Máx 3)</legend>
            <div id="achievements-container" class="space-y-4">
              {% for i in range(3) %} {# Changed range to 0-indexed for consistency with loop.index0 #}
              {% set ach = data.key_achievements[i] if data.key_achievements and i < data.key_achievements|length else {} %}
              <div class="achievement-block p-3 border border-slate-200 rounded-md bg-slate-50 relative">
                  <button type="button" onclick="removeBlock(this, 'achievement-block')" class="remove-btn-style" title="Remover Conquista">×</button> {# Now always visible #}
                  <h4 class="text-md font-medium text-slate-600 mb-2">Conquista {{loop.index}}</h4>
                  <div>
                      <label for="ach_title_{{i}}" class="block text-sm font-medium text-slate-700 mb-1">Título:</label>
                      <input type="text" id="ach_title_{{i}}" name="ach_title[{{i}}]" value="{{ ach.title | default('', true) }}" class="form-input-base">
                  </div>
                  <div class="mt-3">
                      <label for="ach_description_{{i}}" class="block text-sm font-medium text-slate-700 mb-1">Descrição:</label>
                      <textarea id="ach_description_{{i}}" name="ach_description[{{i}}]" rows="2" class="form-textarea-base min-h-[60px]">{{ ach.description | default('', true) }}</textarea>
                  </div>
              </div>
              {% endfor %}
            </div>
            <button type="button" id="add-achievement-btn" class="mt-6 px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">
                + Adicionar Conquista
            </button>
        </fieldset>

        <!-- Courses -->
        <fieldset class="border border-slate-300 p-6 rounded-md">
            <legend class="text-xl font-semibold text-sky-600 px-2 mb-4">Cursos/Certificações (Opcional, Máx 2)</legend>
             <div id="courses-container" class="space-y-4">
                {% for i in range(2) %} {# Changed range to 0-indexed for consistency with loop.index0 #}
                {% set course = data.courses[i] if data.courses and i < data.courses|length else {} %}
                <div class="course-block p-3 border border-slate-200 rounded-md bg-slate-50 relative">
                    <button type="button" onclick="removeBlock(this, 'course-block')" class="remove-btn-style" title="Remover Curso">×</button> {# Now always visible #}
                     <h4 class="text-md font-medium text-slate-600 mb-2">Curso/Cert {{loop.index}}</h4>
                    <div>
                        <label for="course_title_{{i}}" class="block text-sm font-medium text-slate-700 mb-1">Título do Curso/Certificado:</label>
                        <input type="text" id="course_title_{{i}}" name="course_title[{{i}}]" value="{{ course.title | default('', true) }}" class="form-input-base">
                    </div>
                    <div class="mt-3">
                        <label for="course_description_{{i}}" class="block text-sm font-medium text-slate-700 mb-1">Descrição/Instituição:</label>
                        <textarea id="course_description_{{i}}" name="course_description[{{i}}]" rows="2" class="form-textarea-base min-h-[60px]">{{ course.description | default('', true) }}</textarea>
                    </div>
                </div>
                {% endfor %}
             </div>
             <button type="button" id="add-course-btn" class="mt-6 px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">
                + Adicionar Curso
            </button>
        </fieldset>

        <!-- Professional Experience Section -->
        <fieldset class="border border-slate-300 p-6 rounded-md">
            <legend class="text-xl font-semibold text-sky-600 px-2 mb-4">Experiência</legend>
            <div id="experiences-container" class="space-y-6">
                {% for exp in data.experiences %}
                <div class="experience-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
                    <button type="button" onclick="removeBlock(this, 'experience-block')" class="remove-btn-style" title="Remover Experiência">×</button>
                    <h3 class="text-lg font-medium text-slate-700 mb-3">Experiência <span class="item-number">{{ loop.index }}</span></h3>
                    <div class="space-y-4">
                        <div>
                            <label for="exp_title_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Nome da Empresa:</label>
                            <input type="text" id="exp_title_{{loop.index0}}" name="exp_title[{{loop.index0}}]" value="{{ exp.title | default('Tech Solutions Lda', true) }}" class="form-input-base" required>
                        </div>
                        <div>
                            <label for="exp_company_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Cargo:</label>
                            <input type="text" id="exp_company_{{loop.index0}}" name="exp_company[{{loop.index0}}]" value="{{ exp.company | default('Desenvolvedor Web Sênior', true) }}" class="form-input-base">
                        </div>
                        <div>
                            <label for="exp_location_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Localização:</label>
                            <input type="text" id="exp_location_{{loop.index0}}" name="exp_location[{{loop.index0}}]" value="{{ exp.location | default('', true) }}" class="form-input-base">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="exp_start_date_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Data de Início:</label>
                                <input type="month" id="exp_start_date_{{loop.index0}}" name="exp_start_date[{{loop.index0}}]" value="{{ exp.start_date | default('2018-03', true) }}" class="form-input-base">
                            </div>
                            <div>
                                <label for="exp_end_date_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Data de Término:</label>
                                <input type="month" id="exp_end_date_{{loop.index0}}" name="exp_end_date[{{loop.index0}}]" value="{{ exp.end_date | default('', true) }}" class="form-input-base" {% if exp.is_present %}disabled{% endif %}>
                            </div>
                            <div class="flex items-center mb-1 pt-6 md:pt-0 md:self-center"> <!-- Adjusted alignment -->
                                <input type="checkbox" id="exp_present_{{loop.index0}}" name="exp_present[{{loop.index0}}]" class="form-checkbox-base h-5 w-5 text-sky-600 focus:ring-sky-500" onchange="toggleEndDate(this, 'exp_end_date_{{loop.index0}}')" {% if exp.is_present %}checked{% endif %}>
                                <label for="exp_present_{{loop.index0}}" class="ml-2 text-sm text-slate-700">Atualmente trabalho aqui</label>
                            </div>
                        </div>
                        <div>
                            <label for="exp_description_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Descrição da Empresa:</label>
                            <textarea id="exp_description_{{loop.index0}}" name="exp_description[{{loop.index0}}]" rows="5" class="form-textarea-base min-h-[100px]" placeholder="- Liderou o desenvolvimento...">{{ exp.description | default('Empresa líder em desenvolvimento de software personalizado para o setor financeiro.', true) }}</textarea>
                        </div>
                        <div>
                            <label for="exp_achievements_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Principais Conquistas:</label>
                            <textarea id="exp_achievements_{{loop.index0}}" name="exp_achievements[{{loop.index0}}]" rows="5" class="form-textarea-base min-h-[100px]" placeholder="- Liderou o desenvolvimento...">{{ exp.achievements | default('Liderou o desenvolvimento de um novo portal do cliente, resultando em um aumento de 25% na satisfação do cliente.', true) }}</textarea>
                        </div>
                        <div>
                            <label for="exp_responsibilities_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Principais Responsabilidades:</label>
                            <textarea id="exp_responsibilities_{{loop.index0}}" name="exp_responsibilities[{{loop.index0}}]" rows="5" class="form-textarea-base min-h-[100px]" placeholder="- Desenvolvimento e manutenção...">{{ exp.responsibilities | default('Desenvolvimento e manutenção de aplicações web usando Laravel e Vue.js', true) }}</textarea>
                        </div>
                    </div>
                </div>
                {% else %}
                 {# If no experiences, nothing is rendered, user clicks "Add" button #}
                {% endfor %}
            </div>
            <button type="button" id="add-experience-btn" class="mt-6 px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">
                + Adicionar Experiência
            </button>
        </fieldset>

        <!-- Education Section -->
        <fieldset class="border border-slate-300 p-6 rounded-md">
            <legend class="text-xl font-semibold text-sky-600 px-2 mb-4">Educação</legend>
            <div id="education-container" class="space-y-6">
                {% for edu in data.education_entries %}
                <div class="education-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
                    <button type="button" onclick="removeBlock(this, 'education-block')" class="remove-btn-style" title="Remover Educação">×</button>
                    <h3 class="text-lg font-medium text-slate-700 mb-3">Educação <span class="item-number">{{ loop.index }}</span></h3>
                    <div class="space-y-4">
                        <div>
                            <label for="edu_degree_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Escola/Universidade:</label>
                            <input type="text" id="edu_degree_{{loop.index0}}" name="edu_degree[{{loop.index0}}]" value="{{ edu.degree | default('Universidade do Porto', true) }}" class="form-input-base" required>
                        </div>
                        <div>
                            <label for="edu_institution_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Grau e Área de Estudo:</label>
                            <input type="text" id="edu_institution_{{loop.index0}}" name="edu_institution[{{loop.index0}}]" value="{{ edu.institution | default('Licenciatura em Engenharia Informática', true) }}" class="form-input-base">
                        </div>
                        <div>
                            <label for="edu_location_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Ano de Conclusão:</label>
                            <input type="text" id="edu_location_{{loop.index0}}" name="edu_location[{{loop.index0}}]" value="{{ edu.edu_location | default('2015', true) }}" class="form-input-base">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="edu_start_date_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Data de Início:</label>
                                <input type="month" id="edu_start_date_{{loop.index0}}" name="edu_start_date[{{loop.index0}}]" value="{{ edu.start_date | default('', true) }}" class="form-input-base">
                            </div>
                            <div>
                                <label for="edu_end_date_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Data de Término:</label>
                                <input type="month" id="edu_end_date_{{loop.index0}}" name="edu_end_date[{{loop.index0}}]" value="{{ edu.end_date | default('', true) }}" class="form-input-base" {% if edu.is_present %}disabled{% endif %}>
                            </div>
                            <div class="flex items-center mb-1 pt-6 md:pt-0 md:self-center"> <!-- Adjusted alignment -->
                                <input type="checkbox" id="edu_present_{{loop.index0}}" name="edu_present[{{loop.index0}}]" class="form-checkbox-base h-5 w-5 text-sky-600 focus:ring-sky-500" onchange="toggleEndDate(this, 'edu_end_date_{{loop.index0}}')" {% if edu.is_present %}checked{% endif %}>
                                <label for="edu_present_{{loop.index0}}" class="ml-2 text-sm text-slate-700">Atualmente matriculado</label>
                            </div>
                        </div>
                        <div>
                            <label for="edu_details_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Detalhes (e.g., GPA, Honors, Relevant Coursework):</label>
                            <textarea id="edu_details_{{loop.index0}}" name="edu_details[{{loop.index0}}]" rows="3" class="form-textarea-base min-h-[80px]">{{ edu.edu_details | default('', true) }}</textarea>
                        </div>
                    </div>
                </div>
                 {% else %}
                  {# If no education entries, nothing is rendered, user clicks "Add" button #}
                {% endfor %}
            </div>
            <button type="button" id="add-education-btn" class="mt-6 px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">
                + Adicionar Educação
            </button>
        </fieldset>

        <!-- Languages Section -->
        <fieldset class="border border-slate-300 p-6 rounded-md">
            <legend class="text-xl font-semibold text-sky-600 px-2 mb-4">Idiomas</legend>
            <div id="languages-container" class="space-y-6">
                {% for lang in data.languages %}
                <div class="language-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
                    <button type="button" onclick="removeBlock(this, 'language-block')" class="remove-btn-style" title="Remover Idioma">×</button>
                    <h3 class="text-lg font-medium text-slate-700 mb-3">Idioma <span class="item-number">{{ loop.index }}</span></h3>
                    <div class="space-y-4">
                        <div>
                            <label for="lang_name_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Idioma:</label>
                            <select id="lang_name_{{loop.index0}}" name="lang_name[{{loop.index0}}]" class="form-input-base">
                                <option value="Português" {% if lang.name == 'Português' %}selected{% endif %}>Português</option>
                                <option value="Inglês" {% if lang.name == 'Inglês' %}selected{% endif %}>Inglês</option>
                                <option value="Espanhol" {% if lang.name == 'Espanhol' %}selected{% endif %}>Espanhol</option>
                                <option value="Francês" {% if lang.name == 'Francês' %}selected{% endif %}>Francês</option>
                                <option value="Alemão" {% if lang.name == 'Alemão' %}selected{% endif %}>Alemão</option>
                                <!-- Add more languages as needed -->
                            </select>
                        </div>
                        <div>
                            <label for="lang_level_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Nível de Conversação:</label>
                            <select id="lang_level_{{loop.index0}}" name="lang_level[{{loop.index0}}]" class="form-input-base">
                                <option value="Fluente" {% if lang.level == 'Fluente' %}selected{% endif %}>Fluente</option>
                                <option value="Avançado" {% if lang.level == 'Avançado' %}selected{% endif %}>Avançado</option>
                                <option value="Intermediário" {% if lang.level == 'Intermediário' %}selected{% endif %}>Intermediário</option>
                                <option value="Básico" {% if lang.level == 'Básico' %}selected{% endif %}>Básico</option>
                            </select>
                        </div>
                        <div>
                            <label for="lang_reading_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Nível de Leitura:</label>
                            <select id="lang_reading_{{loop.index0}}" name="lang_reading[{{loop.index0}}]" class="form-input-base">
                                <option value="Fluente" {% if lang.reading == 'Fluente' %}selected{% endif %}>Fluente</option>
                                <option value="Avançado" {% if lang.reading == 'Avançado' %}selected{% endif %}>Avançado</option>
                                <option value="Intermediário" {% if lang.reading == 'Intermediário' %}selected{% endif %}>Intermediário</option>
                                <option value="Básico" {% if lang.reading == 'Básico' %}selected{% endif %}>Básico</option>
                            </select>
                        </div>
                        <div>
                            <label for="lang_writing_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Nível de Escrita:</label>
                            <select id="lang_writing_{{loop.index0}}" name="lang_writing[{{loop.index0}}]" class="form-input-base">
                                <option value="Fluente" {% if lang.writing == 'Fluente' %}selected{% endif %}>Fluente</option>
                                <option value="Avançado" {% if lang.writing == 'Avançado' %}selected{% endif %}>Avançado</option>
                                <option value="Intermediário" {% if lang.writing == 'Intermediário' %}selected{% endif %}>Intermediário</option>
                                <option value="Básico" {% if lang.writing == 'Básico' %}selected{% endif %}>Básico</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% else %}
                 {# If no languages, nothing is rendered, user clicks "Add" button #}
                {% endfor %}
            </div>
            <button type="button" id="add-language-btn" class="mt-6 px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">
                + Adicionar Idioma
            </button>
        </fieldset>

        <!-- Additional Information Section -->
        <fieldset class="border border-slate-300 p-6 rounded-md">
            <legend class="text-xl font-semibold text-sky-600 px-2 mb-4">Informações Adicionais</legend>
            <div id="additional-info-container" class="space-y-6">
                {# Initial state: Display nothing if data.additional_info is empty. User clicks button to add. #}
                {% for info in data.additional_info %}
                <div class="info-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
                    <button type="button" onclick="removeBlock(this, 'info-block')" class="remove-btn-style" title="Remover Informação">×</button>
                    <h3 class="text-lg font-medium text-slate-700 mb-3">Informação <span class="item-number">{{ loop.index }}</span></h3>
                    <div class="space-y-4">
                        <div>
                            <label for="info_title_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Título:</label>
                            <input type="text" id="info_title_{{loop.index0}}" name="info_title[{{loop.index0}}]" value="{{ info.title | default('', true) }}" class="form-input-base" required>
                        </div>
                        <div>
                            <label for="info_description_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Descrição:</label>
                            <textarea id="info_description_{{loop.index0}}" name="info_description[{{loop.index0}}]" rows="3" class="form-textarea-base min-h-[80px]">{{ info.description | default('', true) }}</textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-info-btn" class="mt-6 px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">
                + Adicionar Informação
            </button>
        </fieldset>

        <!-- References Section -->
        <fieldset class="border border-slate-300 p-6 rounded-md">
            <legend class="text-xl font-semibold text-sky-600 px-2 mb-4">Referências</legend>
            <div id="references-container" class="space-y-6">
                {# Initial state: Display nothing if data.references is empty. User clicks button to add. #}
                {% for ref in data.references %}
                <div class="reference-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
                    <button type="button" onclick="removeBlock(this, 'reference-block')" class="remove-btn-style" title="Remover Referência">×</button>
                    <h3 class="text-lg font-medium text-slate-700 mb-3">Referência <span class="item-number">{{ loop.index }}</span></h3>
                    <div class="space-y-4">
                        <div>
                            <label for="ref_name_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Nome:</label>
                            <input type="text" id="ref_name_{{loop.index0}}" name="ref_name[{{loop.index0}}]" value="{{ ref.name | default('Maria Santos', true) }}" class="form-input-base" required>
                        </div>
                        <div>
                            <label for="ref_title_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Cargo:</label>
                            <input type="text" id="ref_title_{{loop.index0}}" name="ref_title[{{loop.index0}}]" value="{{ ref.title | default('Gerente de Projetos, Tech Solutions Lda', true) }}" class="form-input-base">
                        </div>
                        <div>
                            <label for="ref_phone_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Telefone:</label>
                            <input type="tel" id="ref_phone_{{loop.index0}}" name="ref_phone[{{loop.index0}}]" value="{{ ref.phone | default('Disponível mediante solicitação', true) }}" class="form-input-base">
                        </div>
                        <div>
                            <label for="ref_description_{{loop.index0}}" class="block text-sm font-medium text-slate-700 mb-1">Descrição:</label>
                            <textarea id="ref_description_{{loop.index0}}" name="ref_description[{{loop.index0}}]" rows="3" class="form-textarea-base min-h-[80px]">{{ ref.description | default('', true) }}</textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-reference-btn" class="mt-6 px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">
                + Adicionar Referência
            </button>
        </fieldset>

        <!-- Skills Section -->
        <fieldset class="border border-slate-300 p-6 rounded-md">
            <legend class="text-xl font-semibold text-sky-600 px-2 mb-4">Habilidades</legend>
            <div class="space-y-4">
                <div>
                    <label for="skills" class="block text-sm font-medium text-slate-700 mb-1">Habilidades:</label>
                    <textarea id="skills" name="skills" rows="4" class="form-textarea-base min-h-[80px]" placeholder="separe habilidades com vírgula ...">{{ data.skills | default('PHP, Laravel, JavaScript, Vue.js, React, Node.js, HTML5, CSS3, Tailwind CSS, SQL (MySQL, PostgreSQL), NoSQL (MongoDB), Git, Docker, REST APIs, GraphQL, Testes Unitários (PHPUnit), Metodologias Ágeis (Scrum), Resolução de Problemas, Comunicação, Trabalho em Equipe', true) }}</textarea>
                </div>
            </div>
        </fieldset>

        <div class="flex justify-end mt-10">
            <button type="submit" class="px-6 py-3 bg-sky-600 text-white font-semibold rounded-md shadow-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 transition ease-in-out duration-150">
                Próximo: Ordenar Seções →
            </button>
        </div>
    </form>
</div>

<!-- Template for Achievement Block -->
<template id="achievement-template">
    <div class="achievement-block p-3 border border-slate-200 rounded-md bg-slate-50 relative">
        <button type="button" onclick="removeBlock(this, 'achievement-block')" class="remove-btn-style" title="Remover Conquista">×</button>
        <h4 class="text-md font-medium text-slate-600 mb-2">Conquista <span class="item-number"></span></h4>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Título:</label>
            <input type="text" name="ach_title[]" class="form-input-base">
        </div>
        <div class="mt-3">
            <label class="block text-sm font-medium text-slate-700 mb-1">Descrição:</label>
            <textarea name="ach_description[]" rows="2" class="form-textarea-base min-h-[60px]"></textarea>
        </div>
    </div>
</template>

<!-- Template for Course Block -->
<template id="course-template">
    <div class="course-block p-3 border border-slate-200 rounded-md bg-slate-50 relative">
        <button type="button" onclick="removeBlock(this, 'course-block')" class="remove-btn-style" title="Remover Curso">×</button>
        <h4 class="text-md font-medium text-slate-600 mb-2">Curso/Cert <span class="item-number"></span></h4>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Título do Curso/Certificado:</label>
            <input type="text" name="course_title[]" class="form-input-base">
        </div>
        <div class="mt-3">
            <label class="block text-sm font-medium text-slate-700 mb-1">Descrição/Instituição:</label>
            <textarea name="course_description[]" rows="2" class="form-textarea-base min-h-[60px]"></textarea>
        </div>
    </div>
</template>

<!-- Template for Experience Block -->
<template id="experience-template">
    <div class="experience-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
        <button type="button" onclick="removeBlock(this, 'experience-block')" class="remove-btn-style" title="Remover Experiência">×</button>
        <h3 class="text-lg font-medium text-slate-700 mb-3">Experiência <span class="item-number"></span></h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Nome da Empresa:</label>
                <input type="text" name="exp_title[]" class="form-input-base" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Cargo:</label>
                <input type="text" name="exp_company[]" class="form-input-base">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Localização:</label>
                <input type="text" name="exp_location[]" class="form-input-base">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Data de Início:</label>
                    <input type="month" name="exp_start_date[]" class="form-input-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Data de Término:</label>
                    <input type="month" name="exp_end_date[]" class="form-input-base">
                </div>
                <div class="flex items-center mb-1 pt-6 md:pt-0 md:self-center">
                    <input type="checkbox" name="exp_present[]" class="form-checkbox-base h-5 w-5 text-sky-600 focus:ring-sky-500" onchange="toggleEndDate(this)">
                    <label class="ml-2 text-sm text-slate-700">Atualmente trabalho aqui</label>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Descrição da Empresa:</label>
                <textarea name="exp_description[]" rows="5" class="form-textarea-base min-h-[100px]" placeholder="- Liderou o desenvolvimento..."></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Principais Conquistas:</label>
                <textarea name="exp_achievements[]" rows="5" class="form-textarea-base min-h-[100px]" placeholder="- Liderou o desenvolvimento..."></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Principais Responsabilidades:</label>
                <textarea name="exp_responsibilities[]" rows="5" class="form-textarea-base min-h-[100px]" placeholder="- Desenvolvimento e manutenção..."></textarea>
            </div>
        </div>
    </div>
</template>

<!-- Template for Education Block -->
<template id="education-template">
    <div class="education-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
        <button type="button" onclick="removeBlock(this, 'education-block')" class="remove-btn-style" title="Remover Educação">×</button>
        <h3 class="text-lg font-medium text-slate-700 mb-3">Educação <span class="item-number"></span></h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Escola/Universidade:</label>
                <input type="text" name="edu_degree[]" class="form-input-base" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Grau e Área de Estudo:</label>
                <input type="text" name="edu_institution[]" class="form-input-base">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Ano de Conclusão:</label>
                <input type="text" name="edu_location[]" class="form-input-base">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Data de Início:</label>
                    <input type="month" name="edu_start_date[]" class="form-input-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Data de Término:</label>
                    <input type="month" name="edu_end_date[]" class="form-input-base">
                </div>
                 <div class="flex items-center mb-1 pt-6 md:pt-0 md:self-center">
                    <input type="checkbox" name="edu_present[]" class="form-checkbox-base h-5 w-5 text-sky-600 focus:ring-sky-500" onchange="toggleEndDate(this)">
                    <label class="ml-2 text-sm text-slate-700">Atualmente matriculado</label>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Detalhes (e.g., GPA, Honors, Relevant Coursework):</label>
                <textarea name="edu_details[]" rows="3" class="form-textarea-base min-h-[80px]"></textarea>
            </div>
        </div>
    </div>
</template>

<!-- Template for Language Block -->
<template id="language-template">
    <div class="language-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
        <button type="button" onclick="removeBlock(this, 'language-block')" class="remove-btn-style" title="Remover Idioma">×</button>
        <h3 class="text-lg font-medium text-slate-700 mb-3">Idioma <span class="item-number"></span></h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Idioma:</label>
                <select name="lang_name[]" class="form-input-base">
                    <option value="Português">Português</option>
                    <option value="Inglês">Inglês</option>
                    <option value="Espanhol">Espanhol</option>
                    <option value="Francês">Francês</option>
                    <option value="Alemão">Alemão</option>
                    <!-- Add more languages as needed -->
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Nível de Conversação:</label>
                <select name="lang_level[]" class="form-input-base">
                    <option value="Fluente">Fluente</option>
                    <option value="Avançado">Avançado</option>
                    <option value="Intermediário">Intermediário</option>
                    <option value="Básico">Básico</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Nível de Leitura:</label>
                <select name="lang_reading[]" class="form-input-base">
                    <option value="Fluente">Fluente</option>
                    <option value="Avançado">Avançado</option>
                    <option value="Intermediário">Intermediário</option>
                    <option value="Básico">Básico</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Nível de Escrita:</label>
                <select name="lang_writing[]" class="form-input-base">
                    <option value="Fluente">Fluente</option>
                    <option value="Avançado">Avançado</option>
                    <option value="Intermediário">Intermediário</option>
                    <option value="Básico">Básico</option>
                </select>
            </div>
        </div>
    </div>
</template>

<!-- Template for Additional Info Block -->
<template id="info-template">
    <div class="info-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
        <button type="button" onclick="removeBlock(this, 'info-block')" class="remove-btn-style" title="Remover Informação">×</button>
        <h3 class="text-lg font-medium text-slate-700 mb-3">Informação <span class="item-number"></span></h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Título:</label>
                <input type="text" name="info_title[]" class="form-input-base" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Descrição:</label>
                <textarea name="info_description[]" rows="3" class="form-textarea-base min-h-[80px]"></textarea>
            </div>
        </div>
    </div>
</template>

<!-- Template for Reference Block -->
<template id="reference-template">
    <div class="reference-block border border-slate-200 p-4 rounded-md bg-slate-50 relative">
        <button type="button" onclick="removeBlock(this, 'reference-block')" class="remove-btn-style" title="Remover Referência">×</button>
        <h3 class="text-lg font-medium text-slate-700 mb-3">Referência <span class="item-number"></span></h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Nome:</label>
                <input type="text" name="ref_name[]" class="form-input-base" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Cargo:</label>
                <input type="text" name="ref_title[]" class="form-input-base">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Telefone:</label>
                <input type="tel" name="ref_phone[]" class="form-input-base">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Descrição:</label>
                <textarea name="ref_description[]" rows="3" class="form-textarea-base min-h-[80px]"></textarea>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block body_end_scripts %}
<script>
    // Keep track of the next index to use for dynamically added blocks
    // Initialized based on the number of blocks rendered from server-side data.
    // If a section is empty initially, its index starts at 0.
    let achievementIndex = {{ data.key_achievements|length if data.key_achievements else 0 }};
    let courseIndex = {{ data.courses|length if data.courses else 0 }};
    let experienceIndex = {{ data.experiences|length if data.experiences else 0 }};
    let educationIndex = {{ data.education_entries|length if data.education_entries else 0 }};
    let languageIndex = {{ data.languages|length if data.languages else 0 }};
    let infoIndex = {{ data.additional_info|length if data.additional_info else 0 }};
    let referenceIndex = {{ data.references|length if data.references else 0 }};

    document.addEventListener('DOMContentLoaded', function () {
        // Initial "Present" checkboxes state for existing items loaded from data
        initializePresentCheckboxes();

        // Add event listeners to buttons for dynamic sections
        document.getElementById('add-achievement-btn').addEventListener('click', () => addDynamicBlock('achievement'));
        document.getElementById('add-course-btn').addEventListener('click', () => addDynamicBlock('course'));
        document.getElementById('add-experience-btn').addEventListener('click', () => addDynamicBlock('experience'));
        document.getElementById('add-education-btn').addEventListener('click', () => addDynamicBlock('education'));
        document.getElementById('add-language-btn').addEventListener('click', () => addDynamicBlock('language'));
        document.getElementById('add-info-btn').addEventListener('click', () => addDynamicBlock('info'));
        document.getElementById('add-reference-btn').addEventListener('click', () => addDynamicBlock('reference'));
    });

    // Function to add a new dynamic block
    function addDynamicBlock(type) {
        const template = document.getElementById(`${type}-template`).content.cloneNode(true);
        const newBlock = template.querySelector(`.${type}-block`);
        const container = document.getElementById(`${type}s-container`); // e.g., experiences-container

        let currentIndex;

        // Determine current index and increment global counter
        if (type === 'achievement') {
            currentIndex = achievementIndex;
            achievementIndex++;
        } else if (type === 'course') {
            currentIndex = courseIndex;
            courseIndex++;
        } else if (type === 'experience') {
            currentIndex = experienceIndex;
            experienceIndex++;
        } else if (type === 'education') {
            currentIndex = educationIndex;
            educationIndex++;
        } else if (type === 'language') {
            currentIndex = languageIndex;
            languageIndex++;
        } else if (type === 'info') {
            currentIndex = infoIndex;
            infoIndex++;
        } else if (type === 'reference') {
            currentIndex = referenceIndex;
            referenceIndex++;
        }

        // Update names and IDs in the cloned template
        newBlock.querySelectorAll('input, textarea, select').forEach(el => {
            const originalName = el.getAttribute('name');
            // Ensure IDs are unique and names are correctly indexed
            if (originalName && originalName.endsWith('[]')) { // Standard array naming from templates
                const baseName = originalName.slice(0, -2); // remove '[]'
                el.name = `${baseName}[${currentIndex}]`;
                el.id = `${baseName}_${currentIndex}`;
            } else if (originalName) { // Fallback for cases where originalName might not have `[]`
                el.id = `${originalName.replace(/[\[\]]/g, '_').replace(/_$/, '')}_${currentIndex}`;
            }
        });

        // Update labels' 'for' attribute to match new input IDs
        newBlock.querySelectorAll('label').forEach(label => {
            const originalFor = label.getAttribute('for');
            if (originalFor) {
                // Determine the base ID without the index suffix
                const baseId = originalFor.replace(/_\d+$/, '');
                // Find the corresponding input/textarea/select element with the new ID
                const targetElement = newBlock.querySelector(`[id="${baseId}_${currentIndex}"]`);
                if (targetElement) {
                    label.htmlFor = targetElement.id;
                }
            }
        });

        // Handle the 'present' checkbox for experience/education specific logic
        if (type === 'experience' || type === 'education') {
            const presentCheckbox = newBlock.querySelector(`input[name*="present"]`);
            if (presentCheckbox) {
                presentCheckbox.id = `${type.slice(0,3)}_present_${currentIndex}`;
                const endDateInput = newBlock.querySelector(`input[name*="end_date"]`);
                if (endDateInput) {
                    endDateInput.id = `${type.slice(0,3)}_end_date_${currentIndex}`;
                    presentCheckbox.onchange = function() { toggleEndDate(this, endDateInput.id); };
                }
            }
            const presentLabel = newBlock.querySelector(`label[for*="present"]`);
            if (presentLabel) {
                 presentLabel.htmlFor = presentCheckbox.id;
            }
        }

        // Update the item number display
        newBlock.querySelector('.item-number').textContent = container.children.length + 1;

        // The remove button style ensures it's visible by default, no need to explicitly show/hide here.
        container.appendChild(newBlock);
    }

    function removeBlock(button, blockClass) {
        const blockToRemove = button.closest('.' + blockClass);
        const container = blockToRemove ? blockToRemove.closest('#achievements-container, #courses-container, #experiences-container, #education-container, #languages-container, #additional-info-container, #references-container') : null;

        if (blockToRemove && container) {
            blockToRemove.remove();
            renumberItems(container, blockClass);

            // Re-adjust the global index after removal
            if (blockClass === 'achievement-block') {
                achievementIndex = container.children.length;
            } else if (blockClass === 'course-block') {
                courseIndex = container.children.length;
            } else if (blockClass === 'experience-block') {
                experienceIndex = container.children.length;
            } else if (blockClass === 'education-block') {
                educationIndex = container.children.length;
            } else if (blockClass === 'language-block') {
                languageIndex = container.children.length;
            } else if (blockClass === 'info-block') {
                infoIndex = container.children.length;
            } else if (blockClass === 'reference-block') {
                referenceIndex = container.children.length;
            }
        }
    }

    function renumberItems(container, blockClass) {
         const remainingBlocks = container.querySelectorAll('.' + blockClass);
         remainingBlocks.forEach((block, index) => {
             const numberSpan = block.querySelector('.item-number');
             if (numberSpan) numberSpan.textContent = index + 1;

             // Re-index input names and IDs to ensure sequential numbering after removal
             block.querySelectorAll('input, textarea, select').forEach(el => {
                const nameParts = el.name.match(/^(.+)\[\d+\]$/); // Match existing index in name
                if (nameParts) {
                    const baseName = nameParts[1];
                    el.name = `${baseName}[${index}]`;
                    el.id = `${baseName}_${index}`; // Update ID as well
                } else {
                    // For elements like skills, no array indexing, just re-id if needed
                    const idParts = el.id.match(/^(.+)_\d+$/);
                    if (idParts) {
                        el.id = `${idParts[1]}_${index}`;
                    }
                }
             });

             // Re-index label 'for' attributes
             block.querySelectorAll('label').forEach(label => {
                const forAttr = label.getAttribute('for');
                if (forAttr) {
                    const baseFor = forAttr.replace(/_\d+$/, '');
                    label.htmlFor = `${baseFor}_${index}`;
                }
            });

            // Special re-indexing and re-binding for present checkbox and its end date
            if (blockClass === 'experience-block' || blockClass === 'education-block') {
                const presentCheckbox = block.querySelector(`input[name*="present"]`);
                const endDateInput = block.querySelector(`input[name*="end_date"]`);
                const presentLabel = block.querySelector(`label[for*="present"]`);

                if (presentCheckbox) {
                    presentCheckbox.id = `${blockClass.startsWith('exp') ? 'exp' : 'edu'}_present_${index}`;
                    if (presentLabel) presentLabel.htmlFor = presentCheckbox.id;
                    // Re-bind onchange with correct new end date ID
                    if (endDateInput) {
                        presentCheckbox.onchange = function() { toggleEndDate(this, endDateInput.id); };
                    }
                }
                if (endDateInput) {
                    endDateInput.id = `${blockClass.startsWith('exp') ? 'exp' : 'edu'}_end_date_${index}`;
                }
            }
         });
    }

    function toggleEndDate(checkboxElement, specificEndDateId = null) {
        let endDateEl;
        if (specificEndDateId) { // Used for initially rendered items with specific IDs
             endDateEl = document.getElementById(specificEndDateId);
        } else { // Used for dynamically added items (find within the same block)
            const parentBlock = checkboxElement.closest('.experience-block, .education-block');
            endDateEl = parentBlock ? parentBlock.querySelector('input[type="month"][name*="end_date"]') : null;
        }

        if (endDateEl) {
            endDateEl.disabled = checkboxElement.checked;
            if (checkboxElement.checked) {
                endDateEl.value = ''; // Clear value when disabling
            }
        } else {
            console.warn("Could not find corresponding end date element for checkbox:", checkboxElement);
        }
    }

    function initializePresentCheckboxes() {
        // Call toggleEndDate for all initially rendered checkboxes based on their checked state
        document.querySelectorAll('input[type="checkbox"][name^="exp_present["], input[type="checkbox"][name^="edu_present["]').forEach(checkbox => {
            // Find the corresponding end date ID (which includes the index)
            const nameAttr = checkbox.getAttribute('name');
            const indexMatch = nameAttr.match(/\[(\d+)\]/);
            if (indexMatch) {
                const index = indexMatch[1];
                const idPrefix = nameAttr.startsWith('exp_') ? 'exp_end_date_' : 'edu_end_date_';
                const endDateId = `${idPrefix}${index}`;
                toggleEndDate(checkbox, endDateId); // Use the specific ID for initial setup
            } else {
                 console.warn("Could not extract index for checkbox:", checkbox);
            }
        });
    }

</script>
<style>
    /* New CSS for the remove buttons */
    .remove-btn-style {
        position: absolute;
        top: 0.25rem; /* ~4px */
        right: 0.25rem; /* ~4px */
        background-color: #fee2e2; /* red-100 */
        color: #b91c1c; /* red-700 */
        font-weight: bold;
        font-size: 1.25rem; /* text-xl */
        width: 2rem; /* w-8 */
        height: 2rem; /* h-8 */
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem; /* rounded-md */
        transition: background-color 150ms ease-in-out, color 150ms ease-in-out, box-shadow 150ms ease-in-out;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        line-height: 1; /* Adjust line height to properly center 'x' */
        z-index: 10; /* Ensure it's above other elements if overlaps occur */
        border: none; /* Remove default button border */
        cursor: pointer;
    }

    .remove-btn-style:hover {
        background-color: #fecaca; /* red-200 */
        color: #991b1b; /* red-900 */
        box-shadow: 0 0 0 2px #f87171, 0 0 0 4px #fee2e2; /* Focus ring on hover */
        outline: none; /* Remove default outline */
    }

    .remove-btn-style:focus {
        outline: none; /* Remove default outline */
        box-shadow: 0 0 0 2px #f87171, 0 0 0 4px #fee2e2; /* Apply focus ring on focus */
    }
</style>
{% endblock %}